{% extends 'operators/base.html' %}

{% block title %}Рабочее пространство - {{ video.original_name }}{% endblock %}

{% block extra_css %}
<style>
    .workspace-grid {
        height: calc(100vh - 200px);
    }
    .video-panel {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .triggers-panel {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .triggers-list {
        flex: 1;
        overflow-y: auto;
    }
    .decision-panel {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .video-wrapper {
        flex: 1;
        position: relative;
        background: #000;
        min-height: 0;
    }
    video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .workspace-grid {
            height: auto;
        }
        
        .video-panel,
        .triggers-panel,
        .decision-panel {
            height: auto;
            margin-bottom: 1rem;
        }
        
        .video-wrapper {
            min-height: 300px;
        }
        
        .triggers-list {
            max-height: 300px;
        }
        
        .task-info .row {
            flex-direction: column;
        }
        
        .task-info .text-end {
            text-align: left !important;
            margin-top: 1rem;
        }
        
        .task-info .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Task Info -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="task-info">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-1">{{ video.original_name }}</h5>
                        <small class="text-muted">
                            Задача #{{ task.id|truncatechars:8 }} | 
                            Начата: {{ task.started_at|date:"H:i" }} |
                            {% if task.expires_at %}
                                Истекает: {{ task.expires_at|date:"H:i" }}
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button 
                            class="btn btn-outline-danger"
                            hx-post="{% url 'operators:release_task' task.id %}"
                            hx-confirm="Вы уверены? Все несохраненные изменения будут потеряны."
                            hx-target="body"
                            hx-indicator="#release-task-spinner">
                            <span id="release-task-spinner" class="htmx-indicator spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Освободить задачу
                        </button>
                        <button 
                            class="btn btn-success ms-2"
                            onclick="completeVerification()"
                            aria-label="Завершить верификацию и отправить результаты">
                            Завершить верификацию
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="row workspace-grid">
        <!-- Left Panel: Video Player -->
        <div class="col-md-5">
            <div class="video-panel">
                <h6>Видеоплеер</h6>
                <div class="video-wrapper">
                    {% if video.signed_url %}
                        <video id="video-player" controls>
                            <source src="{{ video.signed_url }}" type="video/mp4">
                            Ваш браузер не поддерживает видео.
                        </video>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-white">
                                <p>Видео недоступно</p>
                                <small>Нет подписанного URL</small>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div id="timestamp-indicator" class="timestamp-indicator" style="display: none;">
                        <span id="current-time">00:00.000</span>
                    </div>
                </div>
                
                <!-- Decision Summary -->
                <div class="mt-3">
                    <label for="decision_summary" class="form-label">Итоговое решение:</label>
                    <textarea 
                        name="decision_summary" 
                        id="decision_summary" 
                        class="form-control" 
                        rows="3"
                        placeholder="Краткое описание принятых решений..."></textarea>
                </div>
            </div>
        </div>

        <!-- Middle Panel: AI Triggers -->
        <div class="col-md-4">
            <div class="triggers-panel">
                <h6>AI Триггеры ({{ ai_triggers.count }})</h6>
                <div class="triggers-list">
                    {% if ai_triggers %}
                        {% for trigger in ai_triggers %}
                            {% include 'operators/partials/trigger_row.html' with ai_trigger=trigger %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <p>Нет обработанных триггеров</p>
                            <small>Все триггеры обработаны или их не было</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Panel: Decision Form -->
        <div class="col-md-3">
            <div class="decision-panel">
                <h6>Панель решений</h6>
                <div id="decision-panel-content">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-hand-index display-4"></i>
                        <p class="mt-2">Выберите триггер для обработки</p>
                        <small>Нажмите на любой триггер слева</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/operators/workspace.js' %}"></script>
{% endblock %}